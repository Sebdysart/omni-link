#!/usr/bin/env bash
# omni-link session-start hook
# Scans the ecosystem, reads the meta-skill, and injects context into Claude.

set -euo pipefail

# ---------------------------------------------------------------------------
# Resolve paths
# ---------------------------------------------------------------------------
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]:-$0}")" && pwd)"
PLUGIN_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
SKILL_FILE="${PLUGIN_ROOT}/skills/using-omni-link/SKILL.md"
CLI="${PLUGIN_ROOT}/dist/cli.js"

# ---------------------------------------------------------------------------
# Locate config: local .omni-link.json first, then global fallback
# ---------------------------------------------------------------------------
CONFIG_PATH=""
if [[ -f "${PWD}/.omni-link.json" ]]; then
  CONFIG_PATH="${PWD}/.omni-link.json"
elif [[ -f "${HOME}/.claude/omni-link.json" ]]; then
  CONFIG_PATH="${HOME}/.claude/omni-link.json"
fi

# ---------------------------------------------------------------------------
# JSON escape helper (bash parameter substitution — fast)
# ---------------------------------------------------------------------------
escape_for_json() {
    local s="$1"
    s="${s//\\/\\\\}"
    s="${s//\"/\\\"}"
    s="${s//$'\n'/\\n}"
    s="${s//$'\r'/\\r}"
    s="${s//$'\t'/\\t}"
    printf '%s' "$s"
}

if [[ -z "${CONFIG_PATH}" ]]; then
  MSG="omni-link: No config found. Create .omni-link.json in your project root or ~/.claude/omni-link.json to enable ecosystem scanning."
  escaped_msg=$(escape_for_json "$MSG")
  cat <<EOF
{
  "additional_context": "${escaped_msg}",
  "hookSpecificOutput": {
    "hookEventName": "SessionStart",
    "additionalContext": "${escaped_msg}"
  }
}
EOF
  exit 0
fi

# ---------------------------------------------------------------------------
# Run the scan
# ---------------------------------------------------------------------------
DIGEST=""
if [[ -f "${CLI}" ]]; then
  # Capture stderr to a temp file so errors are surfaced in the digest rather
  # than silently discarded (previously 2>/dev/null hid all scan failures).
  SCAN_ERR_LOG=$(mktemp /tmp/omni-link-scan-err.XXXXXX)
  DIGEST=$(node "${CLI}" scan --config "${CONFIG_PATH}" 2>"${SCAN_ERR_LOG}") || {
    SCAN_ERR=$(head -5 "${SCAN_ERR_LOG}" 2>/dev/null | tr '\n' ' ' | sed 's/[[:space:]]*$//')
    DIGEST="omni-link: scan failed${SCAN_ERR:+ — ${SCAN_ERR}}. Context will be partial. Check ${CONFIG_PATH} and ensure all repo paths are accessible."
  }
  rm -f "${SCAN_ERR_LOG}"
else
  DIGEST="omni-link: dist/cli.js not found — run 'npm run build' in the plugin root (${PLUGIN_ROOT})."
fi

# ---------------------------------------------------------------------------
# Read the meta-skill
# ---------------------------------------------------------------------------
SKILL_CONTENT=""
if [[ -f "${SKILL_FILE}" ]]; then
  SKILL_CONTENT=$(<"${SKILL_FILE}")
fi

# ---------------------------------------------------------------------------
# Combine and emit hook response
# ---------------------------------------------------------------------------
if [[ -n "${SKILL_CONTENT}" ]]; then
  CONTEXT="${SKILL_CONTENT}

${DIGEST}"
else
  CONTEXT="${DIGEST}"
fi

escaped_context=$(escape_for_json "$CONTEXT")

cat <<EOF
{
  "additional_context": "${escaped_context}",
  "hookSpecificOutput": {
    "hookEventName": "SessionStart",
    "additionalContext": "${escaped_context}"
  }
}
EOF

exit 0
